# Worktree Parallel Task System Usage Guide

## 🎯 Overview

A system that uses Git worktree to run multiple tasks in parallel.
Each task runs in an independent branch and directory, allowing multiple Claude Code instances to run simultaneously.

## 📦 Installation

```bash
# Claude Config must be installed
cd claude-config
./install.sh

# Check script execution permissions
chmod +x scripts/worktree-manager.sh
```

## 🚀 Quick Start

### 1. Generate Task Plan (Automatic)
```bash
# Automatic generation using plan-agent in Claude
/worktree-plan "Implement authentication, payment, and search features"
```

Or manually:

```bash
# Create template then edit
./scripts/worktree-manager.sh init
vim .worktrees/PLAN.md
```

### 2. Distribute Tasks
```bash
./scripts/worktree-manager.sh distribute
# Or within Claude
/worktree-distribute
```

### 3. Work in Each Worktree
```bash
# Terminal 1
cd .worktrees/auth
claude

# Terminal 2 (new tab/window)
cd .worktrees/payment
claude

# Terminal 3 (new tab/window)
cd .worktrees/search
claude
```

## 📋 Main Commands

### Claude Commands

- `/worktree-plan [task description]` - Automatically generate PLAN.md with plan-agent
- `/worktree-distribute` - Distribute tasks based on PLAN.md
- `/worktree-status` - Check all worktree status
- `/worktree-sync` - Synchronize environment files

### Shell Script

```bash
# Create initial template
./scripts/worktree-manager.sh init

# Execute task distribution
./scripts/worktree-manager.sh distribute

# Check status
./scripts/worktree-manager.sh status

# Synchronize environment files
./scripts/worktree-manager.sh sync
```

## 🗂️ Directory Structure

```
myproject/
├── .worktrees/              # Worktree root
│   ├── PLAN.md              # Task plan
│   ├── tasks/               # Task instructions
│   │   ├── auth.md
│   │   ├── payment.md
│   │   └── search.md
│   ├── auth/                # Worktree 1
│   ├── payment/             # Worktree 2
│   └── search/              # Worktree 3
├── .env                     # Automatically copied
├── package.json             # Automatically copied
└── src/                     # Main code
```

## 🔄 Workflow

### 1. Planning
- Automatically generated by plan-agent with `/worktree-plan` command
- Or write PLAN.md directly
- Each task is designed to be independently executable

### 2. Automatic Distribution
- Create git worktree for each task
- Branch name: `feature/[task-name]`
- Automatically copy environment files (.env, package.json, etc.)
- node_modules connected via symlink (saves disk space)

### 3. Parallel Work
- Run Claude Code independently in each worktree
- Refer to task instructions at `.worktrees/tasks/[task].md`
- Progress simultaneously without interference

### 4. Completion and Merge
```bash
# After task completion, merge to main branch
git checkout main
git merge feature/auth
git merge feature/payment

# Clean up worktree
git worktree remove .worktrees/auth
```

## ✨ Features

### Automatic Environment Copying
The following files are automatically copied:
- `.env`, `.env.local`, `.env.development`
- `package.json`, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`
- `tsconfig.json`, `.eslintrc`, `.prettierrc`
- `docker-compose.yml`
- Python: `requirements.txt`, `pyproject.toml`
- Ruby: `Gemfile`, `Gemfile.lock`

### Dependency Management
- `node_modules` connected via symlink (saves disk space)
- Python `venv` can also be shared via symlink

### Isolated Work Environment
- Each worktree is an independent git branch
- File changes don't affect each other
- Independent commit history

## 💡 Use Case Scenarios

### Scenario 1: Parallel Feature Development
```bash
# PLAN.md
auth: Authentication system
admin: Admin panel
api: REST API

# 3 features developed simultaneously by 3 Claude instances
```

### Scenario 2: Bug Fixes
```bash
# PLAN.md
fix-login: Fix login bug
fix-payment: Fix payment error
fix-search: Improve search performance

# Fix each bug independently
```

### Scenario 3: Refactoring
```bash
# PLAN.md
refactor-auth: Refactor authentication module
refactor-db: Improve DB layer
refactor-ui: Clean up UI components

# Large-scale refactoring by area
```

## 🛠️ Troubleshooting

### When worktree won't create
```bash
# Check existing branches
git branch -a

# Delete branch if needed
git branch -D feature/task-name

# Try again
./scripts/worktree-manager.sh distribute
```

### Synchronize environment files
```bash
# When .env has been modified
./scripts/worktree-manager.sh sync

# Or in Claude
/worktree-sync
```

### Clean up worktree
```bash
# Remove individual worktree
git worktree remove .worktrees/auth

# Clean up all
git worktree prune
rm -rf .worktrees
```

## 📝 Best Practices

1. **Maintain Task Independence**
   - Design tasks to not depend on other tasks
   - Implement common code in main branch first

2. **Appropriate Task Size**
   - Split tasks that are too large
   - Bundle tasks that are too small

3. **Regular Synchronization**
   - Run sync when environment files change
   - Periodically merge main branch changes

4. **Clear Task Descriptions**
   - Document specific task details in PLAN.md
   - Specify completion criteria

## 🔗 Related Documentation

- [Git Worktree Official Documentation](https://git-scm.com/docs/git-worktree)
- [Claude Code Commands](../profiles/account/commands/)
- [Worktree Coordinator Agent](../agents/worktree-coordinator.md)